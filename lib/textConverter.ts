// 漢字をひらがなに変換して自然な日本語音声出力を実現
// 注: このファイルはフォールバック用です。メインはkuromojiConverter.tsを使用してください。

// 医療・歯科関連の専門用語マップ
const medicalTermsMap: { [key: string]: string } = {
  // 歯科専門用語
  '親知らず': 'おやしらず',
  '歯周病': 'ししゅうびょう',
  '虫歯': 'むしば',
  '歯茎': 'はぐき',
  '歯石': 'しせき',
  '歯垢': 'しこう',
  '歯磨き': 'はみがき',
  '歯ブラシ': 'はぶらし',
  '詰め物': 'つめもの',
  '被せ物': 'かぶせもの',
  '根管治療': 'こんかんちりょう',
  '根管': 'こんかん',
  '抜歯': 'ばっし',
  '麻酔': 'ますい',
  '局所麻酔': 'きょくしょますい',
  '歯髄': 'しずい',
  '歯肉': 'しにく',
  '顎関節': 'がくかんせつ',
  '噛み合わせ': 'かみあわせ',
  '咬合': 'こうごう',
  '口腔': 'こうくう',
  '口臭': 'こうしゅう',
  '口内炎': 'こうないえん',
  '知覚過敏': 'ちかくかびん',
  '歯列矯正': 'しれつきょうせい',
  '入れ歯': 'いれば',
  '義歯': 'ぎし',
  'インプラント': 'いんぷらんと',
  'ブリッジ': 'ぶりっじ',
  'クラウン': 'くらうん',
  
  // 医療用語
  '診察': 'しんさつ',
  '診断': 'しんだん',
  '検査': 'けんさ',
  '治療': 'ちりょう',
  '処方': 'しょほう',
  '薬': 'くすり',
  'お薬': 'おくすり',
  '鎮痛薬': 'ちんつうやく',
  '痛み止め': 'いたみどめ',
  '鎮痛剤': 'ちんつうざい',
  '服薬': 'ふくやく',
  '投薬': 'とうやく',
  '注射': 'ちゅうしゃ',
  '点滴': 'てんてき',
  '手術': 'しゅじゅつ',
  '入院': 'にゅういん',
  '通院': 'つういん',
  '既往歴': 'きおうれき',
  '既往症': 'きおうしょう',
  '家族歴': 'かぞくれき',
  '問診': 'もんしん',
  '視診': 'ししん',
  '触診': 'しょくしん',
  '聴診': 'ちょうしん',
  
  // 症状関連
  '症状': 'しょうじょう',
  '痛み': 'いたみ',
  '痛んで': 'いたんで',
  '痛んでいます': 'いたんでいます',
  '痛んでいる': 'いたんでいる',
  '疼痛': 'とうつう',
  '激痛': 'げきつう',
  '鈍痛': 'どんつう',
  '頭痛': 'ずつう',
  '腹痛': 'ふくつう',
  '胸痛': 'きょうつう',
  '腰痛': 'ようつう',
  '関節痛': 'かんせつつう',
  '筋肉痛': 'きんにくつう',
  '神経痛': 'しんけいつう',
  '炎症': 'えんしょう',
  '腫れ': 'はれ',
  '腫脹': 'しゅちょう',
  '発熱': 'はつねつ',
  '悪寒': 'おかん',
  '倦怠感': 'けんたいかん',
  '疲労感': 'ひろうかん',
  '脱力感': 'だつりょくかん',
  '吐き気': 'はきけ',
  '嘔吐': 'おうと',
  '下痢': 'げり',
  '便秘': 'べんぴ',
  '食欲不振': 'しょくよくふしん',
  '不眠': 'ふみん',
  '眩暈': 'めまい',
  '息切れ': 'いきぎれ',
  '動悸': 'どうき',
  '咳': 'せき',
  '痰': 'たん',
  '鼻水': 'はなみず',
  '鼻詰まり': 'はなづまり',
  
  // 病名
  '高血圧': 'こうけつあつ',
  '糖尿病': 'とうにょうびょう',
  '心臓病': 'しんぞうびょう',
  '脳梗塞': 'のうこうそく',
  '脳出血': 'のうしゅっけつ',
  '肺炎': 'はいえん',
  '胃潰瘍': 'いかいよう',
  '十二指腸潰瘍': 'じゅうにしちょうかいよう',
  '肝炎': 'かんえん',
  '腎炎': 'じんえん',
  '膀胱炎': 'ぼうこうえん',
  '関節炎': 'かんせつえん',
  '骨折': 'こっせつ',
  '捻挫': 'ねんざ',
  '打撲': 'だぼく',
  '擦り傷': 'すりきず',
  '切り傷': 'きりきず',
  '火傷': 'やけど',
  '凍傷': 'とうしょう',
  
  // 薬関連
  '解熱剤': 'げねつざい',
  '抗生物質': 'こうせいぶっしつ',
  '抗菌薬': 'こうきんやく',
  '消炎剤': 'しょうえんざい',
  '胃薬': 'いぐすり',
  '下剤': 'げざい',
  '睡眠薬': 'すいみんやく',
  '精神安定剤': 'せいしんあんていざい',
  '降圧剤': 'こうあつざい',
  '血糖値': 'けっとうち',
  'インスリン': 'いんすりん',
  'ステロイド': 'すてろいど',
  'ビタミン': 'びたみん',
  'カルシウム': 'かるしうむ',
  '処方箋': 'しょほうせん',
  '副作用': 'ふくさよう',
  'アレルギー': 'あれるぎー',
  'アナフィラキシー': 'あなふぃらきしー',
  
  // 身体部位
  '頭': 'あたま',
  '顔': 'かお',
  '額': 'ひたい',
  '目': 'め',
  '鼻': 'はな',
  '耳': 'みみ',
  '口': 'くち',
  '唇': 'くちびる',
  '舌': 'した',
  '歯': 'は',
  '顎': 'あご',
  '頬': 'ほほ、ほお',
  '首': 'くび',
  '喉': 'のど',
  '肩': 'かた',
  '腕': 'うで',
  '肘': 'ひじ',
  '手': 'て',
  '指': 'ゆび',
  '胸': 'むね',
  '背中': 'せなか',
  '腹': 'はら、おなか',
  '腰': 'こし',
  '尻': 'しり',
  '脚': 'あし',
  '太もも': 'ふともも',
  '膝': 'ひざ',
  '足': 'あし',
  '踵': 'かかと',
  '爪': 'つめ',
};

// 一般的な漢字変換マップ
const generalKanjiMap: { [key: string]: string } = {
  // 時間関連
  '今日': 'きょう',
  '昨日': 'きのう',
  '明日': 'あした、あす',
  '今週': 'こんしゅう',
  '先週': 'せんしゅう',
  '来週': 'らいしゅう',
  '今月': 'こんげつ',
  '先月': 'せんげつ',
  '来月': 'らいげつ',
  '今年': 'ことし',
  '去年': 'きょねん',
  '来年': 'らいねん',
  '朝': 'あさ',
  '昼': 'ひる',
  '夕方': 'ゆうがた',
  '夜': 'よる',
  '深夜': 'しんや',
  '早朝': 'そうちょう',
  '午前': 'ごぜん',
  '午後': 'ごご',
  '正午': 'しょうご',
  
  // 方向・位置
  '上': 'うえ',
  '下': 'した',
  '右': 'みぎ',
  '左': 'ひだり',
  '前': 'まえ',
  '後': 'うしろ、あと',
  '横': 'よこ',
  '縦': 'たて',
  '中': 'なか',
  '外': 'そと',
  '内': 'うち',
  '表': 'おもて',
  '裏': 'うら',
  '奥': 'おく',
  '手前': 'てまえ',
  '隣': 'となり',
  '近く': 'ちかく',
  '遠く': 'とおく',
  
  // 感情・状態
  '痛い': 'いたい',
  '痛く': 'いたく',
  '痛か': 'いたか',
  '痛': 'いた',
  '辛い': 'つらい',
  '苦しい': 'くるしい',
  '怖い': 'こわい',
  '不安': 'ふあん',
  '心配': 'しんぱい',
  '緊張': 'きんちょう',
  '安心': 'あんしん',
  '楽': 'らく',
  '気持ち': 'きもち',
  '我慢': 'がまん',
  '大丈夫': 'だいじょうぶ',
  
  // 動作
  '食べる': 'たべる',
  '飲む': 'のむ',
  '噛む': 'かむ',
  '話す': 'はなす',
  '聞く': 'きく',
  '見る': 'みる',
  '寝る': 'ねる',
  '起きる': 'おきる',
  '座る': 'すわる',
  '立つ': 'たつ',
  '歩く': 'あるく',
  '走る': 'はしる',
  '来る': 'くる',
  '行く': 'いく',
  '帰る': 'かえる',
  
  // 人称
  '私': 'わたし',
  '僕': 'ぼく',
  '俺': 'おれ',
  '自分': 'じぶん',
  'あなた': 'あなた',
  '彼': 'かれ',
  '彼女': 'かのじょ',
  '先生': 'せんせい',
  '医師': 'いし',
  '医者': 'いしゃ',
  '看護師': 'かんごし',
  '患者': 'かんじゃ',
  
  // その他頻出語
  '病院': 'びょういん',
  '薬局': 'やっきょく',
  '会社': 'かいしゃ',
  '学校': 'がっこう',
  '家': 'いえ',
  '仕事': 'しごと',
  '電話': 'でんわ',
  '名前': 'なまえ',
  '住所': 'じゅうしょ',
  '年齢': 'ねんれい',
  '性別': 'せいべつ',
  '男性': 'だんせい',
  '女性': 'じょせい',
  '子供': 'こども',
  '大人': 'おとな',
  '家族': 'かぞく',
  '友達': 'ともだち',
  
  // 数量
  '一つ': 'ひとつ',
  '二つ': 'ふたつ',
  '三つ': 'みっつ',
  '四つ': 'よっつ',
  '五つ': 'いつつ',
  '六つ': 'むっつ',
  '七つ': 'ななつ',
  '八つ': 'やっつ',
  '九つ': 'ここのつ',
  '十': 'じゅう、とお',
  '百': 'ひゃく',
  '千': 'せん',
  '万': 'まん',
  '少し': 'すこし',
  '沢山': 'たくさん',
  '全部': 'ぜんぶ',
  '半分': 'はんぶん',
};

// 単漢字の読み仮名マップ
const singleKanjiMap: { [key: string]: string } = {
  // 数字
  '一': 'いち',
  '二': 'に',
  '三': 'さん',
  '四': 'よん、し',
  '五': 'ご',
  '六': 'ろく',
  '七': 'なな、しち',
  '八': 'はち',
  '九': 'きゅう、く',
  '十': 'じゅう',
  
  // 曜日
  '月': 'げつ、がつ、つき',
  '火': 'か',
  '水': 'すい、みず',
  '木': 'もく、き',
  '金': 'きん、かね',
  '土': 'ど、つち',
  '日': 'にち、ひ',
  
  // 基本漢字
  '人': 'ひと、じん',
  '子': 'こ',
  '女': 'おんな、じょ',
  '男': 'おとこ、だん',
  '目': 'め、もく',
  '口': 'くち、こう',
  '手': 'て、しゅ',
  '足': 'あし、そく',
  '耳': 'みみ',
  '鼻': 'はな',
  '歯': 'は、し',
  '舌': 'した',
  '頭': 'あたま、とう',
  '顔': 'かお',
  '首': 'くび',
  '肩': 'かた',
  '胸': 'むね',
  '腹': 'はら、ふく',
  '背': 'せ、はい',
  '腰': 'こし、よう',
  '心': 'こころ、しん',
  '体': 'からだ、たい',
  '血': 'ち、けつ',
  '骨': 'ほね、こつ',
  '皮': 'かわ、ひ',
  '肉': 'にく',
  '筋': 'すじ、きん',
  '薬': 'くすり、やく',
  '病': 'やまい、びょう',
  '医': 'い',
  '食': 'しょく',
  '飲': 'いん',
  '眠': 'ねむ、みん',
  '休': 'やす、きゅう',
  '動': 'うご、どう',
  '止': 'と、し',
  '痛': 'いた、つう',
  '苦': 'くる、く',
  '楽': 'らく、がく',
  '強': 'つよ、きょう',
  '弱': 'よわ、じゃく',
  '大': 'おお、だい',
  '小': 'ちい、しょう',
  '長': 'なが、ちょう',
  '短': 'みじか、たん',
  '高': 'たか、こう',
  '低': 'ひく、てい',
  '新': 'あたら、しん',
  '古': 'ふる、こ',
  '良': 'よ、りょう',
  '悪': 'わる、あく',
  '多': 'おお、た',
  '少': 'すく、しょう',
  '早': 'はや、そう',
  '遅': 'おそ、ち',
  '始': 'はじ、し',
  '終': 'お、しゅう',
  '出': 'で、だ、しゅつ',
  '入': 'はい、い、にゅう',
  '上': 'うえ、あ、じょう',
  '下': 'した、さ、か、げ',
  '中': 'なか、ちゅう',
  '外': 'そと、がい',
  '前': 'まえ、ぜん',
  '後': 'あと、うし、ご、こう',
  '左': 'ひだり、さ',
  '右': 'みぎ、う、ゆう',
  '東': 'ひがし、とう',
  '西': 'にし、せい',
  '南': 'みなみ、なん',
  '北': 'きた、ほく',
};

// 数字の読み方を取得するヘルパー関数
function getNumberReading(num: number): string {
  const readings: { [key: number]: string } = {
    1: 'いち', 2: 'に', 3: 'さん', 4: 'よん', 5: 'ご',
    6: 'ろく', 7: 'なな', 8: 'はち', 9: 'きゅう', 10: 'じゅう',
    11: 'じゅういち', 12: 'じゅうに', 13: 'じゅうさん', 14: 'じゅうよん', 15: 'じゅうご',
    16: 'じゅうろく', 17: 'じゅうなな', 18: 'じゅうはち', 19: 'じゅうきゅう', 20: 'にじゅう',
    30: 'さんじゅう', 40: 'よんじゅう', 50: 'ごじゅう', 60: 'ろくじゅう', 70: 'ななじゅう',
    80: 'はちじゅう', 90: 'きゅうじゅう', 100: 'ひゃく'
  };

  if (readings[num]) {
    return readings[num];
  }

  // 2桁の数字を処理
  if (num > 20 && num < 100) {
    const tens = Math.floor(num / 10) * 10;
    const ones = num % 10;
    if (ones === 0) {
      return readings[tens];
    }
    return readings[tens] + readings[ones];
  }

  // それ以外はそのまま返す
  return num.toString();
}

// 半角数字を日本語の読みに変換するヘルパー関数
function convertHalfWidthNumbers(text: string): string {
  // 単独の半角数字を変換（単位がついていないもの）
  text = text.replace(/\b(\d+)\b(?![年月日時分秒歳円人個本枚回度番階丁目])/g, (match, p1) => {
    const num = parseInt(p1);
    if (num >= 0 && num <= 100) {
      return getNumberReading(num);
    }
    return match;
  });

  return text;
}

// 自然な音声のための追加処理
function addNaturalPauses(text: string): string {
  // 句読点の後に短いポーズを追加
  text = text.replace(/。/g, '。　');
  text = text.replace(/、/g, '、　');
  text = text.replace(/？/g, '？　');
  text = text.replace(/！/g, '！　');
  
  // 長い文の場合、適切な位置にポーズを追加
  if (text.length > 30) {
    // 「て」「で」「が」「けど」の後にわずかなポーズ
    text = text.replace(/て([^。、])/g, 'て　$1');
    text = text.replace(/で([^。、])/g, 'で　$1');
    text = text.replace(/が([^。、])/g, 'が　$1');
    text = text.replace(/けど/g, 'けど　');
  }
  
  return text;
}

// 数字の読み方を処理
function convertNumbers(text: string): string {
  // 「〜日前から」のパターンを最初に処理
  text = text.replace(/(\d+)日前から/g, (match, p1) => {
    const num = parseInt(p1);
    // 1-10日は特殊な読み方
    const dayReadings: { [key: number]: string } = {
      1: 'いちにち', 2: 'ふつか', 3: 'みっか', 4: 'よっか', 5: 'いつか',
      6: 'むいか', 7: 'なのか', 8: 'ようか', 9: 'ここのか', 10: 'とおか'
    };
    const reading = dayReadings[num] || `${getNumberReading(num)}にち`;
    return `${reading}まえから`;
  });

  // 「〜日前」「〜日後」などの複合パターンを先に処理
  text = text.replace(/(\d+)日前/g, (match, p1) => {
    const num = parseInt(p1);
    // 1-10日は特殊な読み方
    const dayReadings: { [key: number]: string } = {
      1: 'いちにち', 2: 'ふつか', 3: 'みっか', 4: 'よっか', 5: 'いつか',
      6: 'むいか', 7: 'なのか', 8: 'ようか', 9: 'ここのか', 10: 'とおか'
    };
    const reading = dayReadings[num] || `${getNumberReading(num)}にち`;
    return `${reading}まえ`;
  });
  text = text.replace(/(\d+)日後/g, (match, p1) => {
    const num = parseInt(p1);
    const dayReadings: { [key: number]: string } = {
      1: 'いちにち', 2: 'ふつか', 3: 'みっか', 4: 'よっか', 5: 'いつか',
      6: 'むいか', 7: 'なのか', 8: 'ようか', 9: 'ここのか', 10: 'とおか'
    };
    const reading = dayReadings[num] || `${getNumberReading(num)}にち`;
    return `${reading}ご`;
  });
  text = text.replace(/(\d+)日間/g, (match, p1) => {
    const num = parseInt(p1);
    const dayReadings: { [key: number]: string } = {
      1: 'いちにち', 2: 'ふつか', 3: 'みっか', 4: 'よっか', 5: 'いつか',
      6: 'むいか', 7: 'なのか', 8: 'ようか', 9: 'ここのか', 10: 'とおか'
    };
    const reading = dayReadings[num] || `${getNumberReading(num)}にち`;
    return `${reading}かん`;
  });

  // 特殊な読み方（日付として）
  text = text.replace(/1日/g, 'ついたち');
  text = text.replace(/2日/g, 'ふつか');
  text = text.replace(/3日/g, 'みっか');
  text = text.replace(/4日/g, 'よっか');
  text = text.replace(/5日/g, 'いつか');
  text = text.replace(/6日/g, 'むいか');
  text = text.replace(/7日/g, 'なのか');
  text = text.replace(/8日/g, 'ようか');
  text = text.replace(/9日/g, 'ここのか');
  text = text.replace(/10日/g, 'とおか');
  text = text.replace(/20日/g, 'はつか');
  
  // 年月日時分の読み方
  text = text.replace(/(\d+)年/g, '$1ねん');
  text = text.replace(/(\d+)月/g, '$1がつ');
  text = text.replace(/(\d+)時/g, '$1じ');
  text = text.replace(/(\d+)分/g, (match, p1) => {
    const num = parseInt(p1);
    if (num === 3) return 'さんぷん';
    if (num === 4) return 'よんぷん';
    if (num === 10) return 'じゅっぷん';
    return `${p1}ふん`;
  });
  text = text.replace(/(\d+)秒/g, '$1びょう');
  
  // その他の単位
  text = text.replace(/(\d+)歳/g, '$1さい');
  text = text.replace(/(\d+)円/g, '$1えん');
  text = text.replace(/(\d+)人/g, '$1にん');
  text = text.replace(/(\d+)個/g, '$1こ');
  text = text.replace(/(\d+)本/g, '$1ほん');
  text = text.replace(/(\d+)枚/g, '$1まい');
  text = text.replace(/(\d+)回/g, '$1かい');
  text = text.replace(/(\d+)度/g, '$1ど');
  text = text.replace(/(\d+)番/g, '$1ばん');
  text = text.replace(/(\d+)階/g, '$1かい');
  text = text.replace(/(\d+)丁目/g, '$1ちょうめ');
  
  return text;
}

// メイン変換関数（フォールバック用）
export function convertKanjiToHiragana(text: string): string {
  let convertedText = text;
  
  // 1. 医療・歯科専門用語を優先的に変換（長い語句から）
  const medicalKeys = Object.keys(medicalTermsMap).sort((a, b) => b.length - a.length);
  medicalKeys.forEach(term => {
    const reading = medicalTermsMap[term];
    const regex = new RegExp(term, 'g');
    convertedText = convertedText.replace(regex, reading);
  });
  
  // 2. 一般的な複合語を変換
  const generalKeys = Object.keys(generalKanjiMap).sort((a, b) => b.length - a.length);
  generalKeys.forEach(kanji => {
    const reading = generalKanjiMap[kanji];
    // 複数の読み方がある場合は最初のものを使用
    const primaryReading = reading.split('、')[0];
    const regex = new RegExp(kanji, 'g');
    convertedText = convertedText.replace(regex, primaryReading);
  });
  
  // 3. 単漢字を変換（文脈を考慮できないため最後に処理）
  Object.keys(singleKanjiMap).forEach(kanji => {
    const reading = singleKanjiMap[kanji];
    const primaryReading = reading.split('、')[0];
    const regex = new RegExp(kanji, 'g');
    convertedText = convertedText.replace(regex, primaryReading);
  });
  
  // 4. 数字の特殊な読み方を処理
  convertedText = convertNumbers(convertedText);

  // 5. 半角数字の読み方を処理
  convertedText = convertHalfWidthNumbers(convertedText);

  // 6. 自然な音声のためのポーズを追加
  convertedText = addNaturalPauses(convertedText);

  // 7. 不要な空白を整理
  convertedText = convertedText.replace(/　+/g, '　');
  convertedText = convertedText.trim();
  
  return convertedText;
}

// テスト用関数
export function testConversion() {
  const testCases = [
    "今日は右下の奥歯が痛いです。",
    "3日前から歯茎が腫れています。",
    "親知らずの抜歯をお願いします。",
    "麻酔注射は痛くないですか？",
    "歯周病の治療はどのくらいかかりますか？",
    "高血圧と糖尿病の薬を飲んでいます。",
    "アレルギーはペニシリンです。",
    "10年前に親知らずを抜きました。",
    "冷たいものを飲むとズキズキ痛みます。",
    "夜も眠れないくらい痛いです。",
    "仕事に集中できなくて困っています。",
    "できれば歯を残したいのですが。",
    "他に伝えておきたいことはありますか？",
    "特にないです。よろしくお願いします。",
  ];
  
  console.log('=== 音声変換テスト ===\n');
  testCases.forEach(text => {
    const converted = convertKanjiToHiragana(text);
    console.log(`元の文: ${text}`);
    console.log(`変換後: ${converted}`);
    console.log('---');
  });
}
